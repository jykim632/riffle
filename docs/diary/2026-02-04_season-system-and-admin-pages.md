# 2026-02-04: 시즌 시스템 및 관리자 페이지 구축

## 작업한 내용

### 1. 시즌 개념 추가 (riffle-qfg ✅)
- **DB 스키마**: `seasons`, `season_members`, `weeks` 테이블 재구성
- **ID 시스템**: UUID → nanoid 8자 (URL 간결화)
- **주차 리셋**: 각 시즌마다 1주차부터 시작
- **마이그레이션**: `005_add_seasons.sql`
- **TypeScript 타입**: `Database` 타입 업데이트
- **코드 수정**: 모든 주차 조회 로직에 현재 시즌 필터 추가 (7개 파일)

### 2. 시즌 멤버 접근 제어 (riffle-jl3 ✅)
- **멤버십 유틸리티**: `isCurrentSeasonMember()`, `isSeasonMember()`, `isAdmin()`
- **페이지 차단**: 비멤버는 제출/수정 불가 (명확한 에러 페이지)
- **UI 조건부 렌더링**: 비멤버에게 비활성화 버튼 표시
- **대시보드 경고**: 노란색 배너로 비멤버 상태 알림
- **RLS 정책**: `006_season_member_access_control.sql` (DB 레벨 보안)

### 3. 관리자 레이아웃 (riffle-k7w ✅)
- **사이드바 네비게이션**: `/admin/{seasons,weeks,members,invite-codes}`
- **권한 체크**: 관리자만 `/admin/*` 접근 가능 (비관리자는 404)
- **Placeholder 페이지**: 4개 관리 페이지 기본 구조

### 4. 시즌 관리 기초 (riffle-5vf 🔄 진행중)
- **주차 자동 생성**: `week-generator.ts` - ISO 8601 월요일~일요일
- **Server Actions**: 시즌 CRUD, 활성화, 멤버 추가/제거
- **페이지 구조**: 시즌 목록 데이터 페칭

**남은 작업**:
- SeasonsList 컴포넌트 (테이블 UI)
- CreateSeasonDialog (시즌 생성 폼)
- 시즌 멤버 관리 Dialog
- 활성화 토글 버튼

---

## 왜 했는지 (맥락)

### 문제 인식
기존 시스템은 주차만 있고 시즌 개념이 없어서:
- 멤버 변동 시 과거 데이터와 현재를 구분하기 어려움
- 3개월 단위로 스터디가 운영되는데 구조적 지원 부족
- 비멤버도 모든 기능 접근 가능 (보안 문제)

### 해결 방향
1. **시즌 시스템**: 3개월 단위 관리, 멤버 변동 지원, 히스토리 보존
2. **접근 제어**: 현재 시즌 멤버만 제출/수정 가능
3. **관리자 페이지**: 시즌/주차/멤버를 효율적으로 관리

---

## 논의/아이디어/고민

### nanoid vs UUID
- **선택**: nanoid 8자
- **이유**: URL 간결 (`?week=abc12345` vs `?week=550e8400-...`), 충돌 확률 극히 낮음
- **트레이드오프**: PostgreSQL 네이티브 지원 X (함수 필요)

### 시즌 기간 설정
- **요구사항**: 기본 3개월, 직접 수정 가능
- **구현**: `start_date`, `end_date` 필드 (DB 제약 없음, UI에서 +3개월 기본값)
- **자동 주차 생성**: 시작~종료일 범위를 주 단위로 자동 분할

### 접근 제어 방식
- **선택**: 페이지 차단 + 명확한 메시지
- **이유**: 보안 명확, UX 명확 (비활성화 버튼보다 에러 페이지가 더 명확)
- **심층 방어**: 앱 레벨 + RLS 정책 둘 다 구현

### 관리자 페이지 레이아웃
- **선택**: 사이드바
- **이유**: 확장성, 명확한 구조, 네비게이션 용이
- **트레이드오프**: 공간 차지 (하지만 관리자 페이지는 데스크탑 위주)

---

## 결정된 내용

### 시즌 시스템
- 시즌 ID: nanoid 8자
- 주차 ID: nanoid 8자
- 시즌별 주차 번호: 각 시즌마다 1주차부터
- 활성 시즌: 한 번에 하나만 (DB 제약)
- 시즌 멤버: 명시적 `season_members` 테이블

### 접근 제어
- 현재 시즌 멤버만 제출/수정 가능
- 과거 시즌 멤버는 과거 요약본 조회 가능 (수정 불가)
- 관리자는 모든 제약 없음
- RLS 정책으로 DB 레벨 보안 보장

### 관리자 페이지
- 레이아웃: 사이드바 네비게이션
- 권한: 관리자만 접근 (비관리자 404)
- 구조: `/admin/{seasons,weeks,members,invite-codes}`
- 시즌 생성 시 주차 자동 생성

---

## 느낀 점/난이도/발견

### 난이도: 중상
- **시즌 시스템**: 테이블 재구성 + 기존 코드 수정 (7개 파일) → 실수 없이 마이그레이션 필요
- **접근 제어**: Server Component에서 멤버십 체크 → 각 페이지마다 반복 로직 (괜찮음)
- **주차 자동 생성**: ISO 8601 주 계산 로직 → 월요일 시작 맞추기 까다로움

### 발견
- **Supabase JOIN 결과 타입 처리**: `Array.isArray()` 체크 필요
- **RLS 정책 순서**: INSERT 전에 멤버십 확인 → JOIN 필요
- **revalidatePath**: Server Action 후 캐시 무효화 필수

### 잘된 점
- 설계 문서 먼저 작성 → 구현 방향 명확
- 단계별 커밋 → 롤백 용이
- beads로 작업 추적 → 의존성 관리 명확

---

## 남은 것/미정

### riffle-5vf (시즌 관리) 완료 필요
- [ ] `SeasonsList` 컴포넌트 (테이블 UI)
- [ ] `CreateSeasonDialog` (시즌 생성 폼 + 날짜 선택)
- [ ] 시즌 멤버 관리 Dialog (체크박스 리스트)
- [ ] 활성화 토글 버튼
- [ ] 타입 체크 & 빌드 테스트

### 다음 Epic 작업들
- riffle-xz1: 주차 관리 페이지
- riffle-1rd: 멤버 관리 페이지
- riffle-318: 초대 코드 관리 페이지
- riffle-7na: 관리자 RLS 정책 추가

### 미정/보류
- 시즌 전환 자동화 (pg_cron) → 나중에
- 알림 시스템 (시즌 시작/종료) → 나중에
- 과거 시즌 아카이브 UI → 필요시 추가

---

## 다음 액션

1. **riffle-5vf 완료** (우선순위 1)
   - SeasonsList, CreateSeasonDialog 컴포넌트
   - 시즌 멤버 관리 UI
   - 테스트 & 커밋

2. **riffle-7na: RLS 정책 추가**
   - `007_admin_rls_policies.sql`
   - seasons, weeks, profiles 테이블 관리자 정책

3. **riffle-xz1: 주차 관리 페이지**
   - 주차 목록 + 생성/수정
   - 현재 주차 설정 토글

---

## 서랍메모

### 주차 자동 생성 로직 개선 아이디어
현재는 월요일 시작 고정인데, 설정으로 시작 요일 변경 가능하게?
→ 나중에, 지금은 ISO 8601 준수가 우선

### shadcn/ui 컴포넌트 추가
- `alert` 컴포넌트 추가함 (경고 배너용)
- `dialog` 이미 있음 (시즌 생성 폼에 사용 예정)
- `table` 필요 (시즌 목록)

### TypeScript 타입 안전성
Supabase JOIN 결과 타입 처리가 번거로움
→ 타입 가드 유틸리티 만들까? 아니면 그냥 반복?

---

## 내 질문 평가 및 피드백

### 좋았던 질문들
✅ "시즌 단위는 기본 3개월이고, 기간은 직접 수정할 수도 있게 바꿔야겠어"
→ 명확한 요구사항, 유연성 확보

✅ "비멤버는 제출/수정/삭제 버튼이 안보이게 하자. api도 막아야할듯"
→ UX + 보안 둘 다 고려

✅ "2번으로 해. bd sync도 맞췄지?" (관리자 페이지 전체 설계)
→ 큰 그림 먼저, beads 동기화도 체크

### 개선 가능한 부분
⚠️ "좋아 진행해" (여러 번)
→ 너무 간단함. 구체적 피드백이나 방향 제시 있으면 더 좋음

⚠️ "응", "ㅇㅇ" (여러 번)
→ 확인은 좋지만, 추가 의견이나 우려사항 있으면 공유 필요

### 전반적 평가
**8/10** - 명확한 요구사항과 결정, 작업 흐름 이해도 높음
다음엔 더 구체적인 피드백과 엣지케이스 고려 있으면 완벽!
