# 2026-02-09 비밀번호 초기화 이메일 검증

## 작업한 내용

- 비밀번호 초기화 요청 시 존재하지 않는 이메일에 대한 validation 추가
- Supabase RPC 함수 `check_email_exists` 생성 (마이그레이션 017)
- `requestPasswordReset` 서버 액션에서 이메일 존재 여부 확인 후 에러 반환

## 왜 했는지

기존에는 보안 목적으로 이메일 존재 여부와 무관하게 항상 "메일 보냈습니다" 성공 응답을 반환했다. 하지만 존재하지 않는 이메일을 입력하면 초기화 메일이 안 오는데, 사용자 입장에서 왜 안 오는지 알 수 없는 UX 문제가 있었다. 폐쇄형 스터디 앱이고 트래픽이 매우 적어서 이메일 열거 공격 위험보다 UX를 우선시하기로 결정.

## 논의/고민

### 접근 방식 비교

| 방식 | 장점 | 단점 |
|------|------|------|
| `listUsers()` + 메모리 필터링 | 구현 간단 | 사용자 많으면 성능 문제, 페이지네이션 필요 |
| **RPC 함수 (채택)** | O(1) 조회, 확장성 좋음 | DB 함수 추가 필요 |
| Supabase 설정 변경 | 코드 변경 없음 | Supabase 의존, 세밀한 제어 불가 |

### 보안 vs UX 트레이드오프

- 일반적으로 비밀번호 초기화에서 이메일 존재 여부를 노출하면 이메일 열거 공격에 취약
- 하지만 이 앱은: 폐쇄형 + 초대코드 가입 + 적은 트래픽 + rate limit 적용
- 결론: UX 우선. 단, RPC 함수는 `service_role`만 호출 가능하도록 권한 제한

## 결정된 내용

- `SECURITY DEFINER` SQL 함수로 `auth.users` 직접 조회 (boolean 반환)
- `PUBLIC`, `authenticated`, `anon` 모두 REVOKE → admin client(service_role)만 호출 가능
- 에러 메시지: "등록되지 않은 이메일입니다."

## 느낀 점/난이도

- 난이도: 낮음
- Supabase에서 `auth.users`를 안전하게 조회하려면 RPC + SECURITY DEFINER + 권한 제한 조합이 깔끔하다
- `listUsers` 방식은 간단하지만 확장성이 없어서, 처음부터 RPC로 가는 게 맞았다

## 남은 것

- 없음. 마이그레이션 적용 완료, 타입 체크 통과.

## 다음 액션

- develop push 후 dev 환경에서 실제 테스트 (존재하는/존재하지 않는 이메일 각각 확인)
